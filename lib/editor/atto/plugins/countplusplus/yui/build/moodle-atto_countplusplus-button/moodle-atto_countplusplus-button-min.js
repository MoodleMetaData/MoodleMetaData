YUI.add("moodle-atto_countplusplus-button",function(e,t){function i(){var e=function(e){return e.replace(/\s+/g,"")},t=function(e,t){if(typeof t=="undefined"||t===null)t="*";return e=e.replace(/&nbsp;/g," "),e=e.replace(r,t),e},n=function(e,t,n){var r=/<([a-z][a-z0-9]*)\b[^>]*>/gi,i,s=0;while((i=r.exec(e))!==null){var o=t[s],u=e.slice(0,i.index+i[0].length),a=e.slice(i.index+i[0].length,e.length);if(n[s]){var f=a.slice(0,o.innerHTML.length),l=a.slice(o.innerHTML.length,a.length);a=" "+f+" "+l,e=u+a}s++}return e},i=function(e,t){t=(((t||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var n=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,r=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return e.replace(r,"").replace(n,function(e,n){return t.indexOf("<"+n.toLowerCase()+">")>-1?e:""})};this.getWordCount=function(e,r,s){var o=e;o=n(o,r,s),o=t(o),o=i(o).trim();var u=0,a=!1;return o.split(/\s+/g).forEach(function(e){e.length>0&&a===!1&&u++;var t=e.trim();a=/[^\-]-$/.test(t)}),u},this.getLetterCount=function(n){var r=n;return r=t(r),r=i(r),r=e(r),r.length}}var n={};n.getDisplayType=function(e){var t=e.currentStyle||window.getComputedStyle(e,"");return t.display},n.buildIsBlockArray=function(e){var t=[];return e.forEach(function(e){t[t.length]=n.getDisplayType(e).toLowerCase()==="block"||e.tagName.toLowerCase()==="br"}),t};var r=/&[a-zA-Z\d]{1,10};/g,s="Word count: %wc | Letter count: %lc";SPAN_TYPE={wordCount:0,letterCount:1},Object.freeze(SPAN_TYPE),SPAN_STR_TO_TYPE_MAP={"%wc":SPAN_TYPE.wordCount,"%lc":SPAN_TYPE.letterCount},Object.freeze(SPAN_STR_TO_TYPE_MAP);var o=/(%wc|%lc|\|)/g,u="atto_countplusplus",a='<span id="{{id}}">0</span>';e.namespace("M.atto_countplusplus").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){this._stat=new i,this._instance_count=e.M.atto_countplusplus.Button.INSTANCE_COUNTER++,this._id=u+"-"+this._instance_count,this.spanId=[],this.spanStatType=[],this.delay=350,this.layout=s,this.updateEvent=function(){},this.layout=this.get("statlayout"),this.setupStatusbar(),this._update(),this._setupEventHandlers()},_setupEventHandlers:function(){var t=this;e.on("change",function(e){void e,window.clearTimeout(t.updateEvent),t.updateEvent=setTimeout(t._getUpdateWithThisClosure(),t.delay)})},_getUpdateWithThisClosure:function(){var e=this;return function(){e._update()}},_update:function(){var e=this.get("host").editor.getDOMNode().querySelectorAll("*"),t=[];[].forEach.call(e,function(e){t[t.length]=e});var r=this._stat.getWordCount(this._getEditorText(),t,n.buildIsBlockArray(t)),i=this._stat.getLetterCount(this._getEditorText());this._updateComponents(r,i)},_updateComponents:function(e,t){var n=this;this.spanId.forEach(function(r,i){var s=0;switch(n.spanStatType[i]){case SPAN_TYPE.wordCount:s=e;break;case SPAN_TYPE.letterCount:s=t;break;default:console.log("Fatal Error: Unrecognized span type."),s=-1}n._setSpanValue(s,i)})},setupStatusbar:function(){var e=this.get("host");e.setupStatusbar(),e.addStatusbarNode(this._generateStatNode())},_setSpanValue:function(t,n){var r=e.DOM.byId(this.spanId[n]);e.DOM.setText(r,t)},_getEditorText:function(){return this.get("host").getCleanHTML()},_getStatSpan:function(t){var n=e.Handlebars.compile(a);return n({id:t})},_getSpanId:function(e){return this._id+"-"+"span-"+e},_generateNthSpan:function(e,t){var n=this._getSpanId(e),r=this._getStatSpan(n);return this.spanId[this.spanId.length]=n,this.spanStatType[this.spanStatType.length]=SPAN_STR_TO_TYPE_MAP[t],r},_generateStatNode:function(){function i(e){var i="";return e==="|"?i=r.getSeparator():(i=n._generateNthSpan(t,e),t++),i}var t=0,n=this,r=this.get("host"),s=this.layout.replace(o,i),u=e.Node.create("<div/>");return u.appendChild(e.Node.create(s)),u}},{INSTANCE_COUNTER:0,ATTRS:{statlayout:{value:s}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
